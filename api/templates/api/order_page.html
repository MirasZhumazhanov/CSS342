{% load static %}

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Stylesheets -->
    <link rel="stylesheet" href="{% static 'css/order_page.css' %}" />

    <!-- Google Fonts for Material Symbols Outlined -->
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@400"
      integrity="sha384-..."
      crossorigin="anonymous"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.10.2/fullcalendar.min.css"
      rel="stylesheet"
    />

    <title>Order</title>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Saira+Semi+Condensed:wght@100;200;300;400;500;600;700;800;900&display=swap");
      @import url("https://fonts.googleapis.com/css2?family=Saira+Condensed:wght@100;200;300;400;500;600;700;800;900&family=Saira+Semi+Condensed:wght@100;200;300;400;500;600;700;800;900&display=swap");
      .custom-alert {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        padding: 20px;
        background-color: #ffffff;
        border: 2px solid #333333;
        border-radius: 10px;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.4);
        z-index: 9999;
        max-width: 400px;
        text-align: center;
      }

      /* Close button */
      .close-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        cursor: pointer;
        font-size: 16px;
        color: #333333;
      }

      /* Close button on hover */
      .close-btn:hover {
        color: #ff0000;
      }

      /* Alert message */
      .custom-alert span {
        display: block;
        margin-top: 20px;
        font-size: 18px;
        color: #333333;
      }
      body {
        margin: 0px;
        font-family: "Saira Semi Condensed", sans-serif;
        font-weight: 500;
      }

      .main {
        width: 80vw;
        position: relative;
        transform: translate(210px, 40px);
        margin-top: -20px;
      }
      .header {
        height: 152px;
        background: #3949ab;
        border-radius: 15px;
        display: flex;
        align-items: center;
        justify-content: space-around;
        margin: 8px;
      }

      .topic-link {
        text-decoration: none;
        color: #e8eaf6;
      }

      .topic-text {
        font-family: "Saira Condensed", sans-serif;
        font-size: 48px;
        font-weight: 800;
      }

      .list {
        display: flex;
        column-gap: 90px;
        list-style: none; /* Add this line to remove the dots */
      }

      .link {
        color: #e8eaf6;
        text-decoration: none;
        font-size: 24px;
        font-weight: 500;
      }

      .line {
        border-bottom: 3px solid #e8eaf6;
      }

      .dropdown {
        position: relative;
        display: inline-block;
      }

      .dropdown-checkbox {
        display: none;
      }

      .dropdown-label {
        padding: 10px;
        color: black;
        cursor: pointer;
        display: inline-block;
      }

      .dropdown-content {
        display: none;
        position: absolute;
        background-color: #f9f9f9;
        min-width: 160px;
        box-shadow: 0px 8px 16px 0px rgba(0, 0, 0, 0.2);
        z-index: 1;
      }

      .dropdown-content a {
        color: black;
        padding: 12px 16px;
        text-decoration: none;
        display: block;
      }

      .dropdown-checkbox:checked + .dropdown-label + .dropdown-content {
        display: block;
      }

      .dropdown-content a:hover {
        background-color: #f1f1f1;
      }

      .dropdown-label img {
        cursor: pointer;
        border: none !important;
      }
      .nextpage a {
        color: #3949ab;
        font-family: "Saira Condensed", sans-serif;
        font-weight: 600;
        display: inline-block;
        text-decoration: none;
        font-size: 24px;
      }

      .nextpage a:not(:last-child)::after {
        content: " >";
      }

      .utilities {
        display: flex;
        padding: 50px;
        justify-content: space-evenly;
        margin-left: -150px !important;
      }
      .pay {
        background: #1a237e;
        border-radius: 15px;
        height: 50px;
        width: 300px;
        display: flex;
        justify-content: center;
        align-items: center;
        font-family: "Saira Semi Condensed", sans-serif;
        font-weight: 800;
        font-size: 20px;
        color: #ffffff;
        margin-bottom: 50px;
        margin-left: 25%;
      }
      p {
        font-family: "Saira Semi Condensed", sans-serif;
        font-weight: 700;
        font-size: 40px; /* Adjust font size as needed */
        color: #333; /* Adjust text color as needed */

        margin-left: 18%;
        color: #1a237e;
      }
      .top {
        display: flex;
        margin-top: -50px;
        justify-content: center;
        column-gap: 50px;
        margin-top: 5px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header class="header">
        <!-- Logo -->
        <div class="topic">
          <a href="{% url 'home' %}" class="topic-link">
            <span class="topic-text">HappyClient</span>
          </a>
        </div>

        <!-- Navigation Menu -->
        <nav class="navbar">
          <ul class="list">
            <li class="link-list">
              <a href="/search" class="link line">Billboards</a>
            </li>
            <li class="link-list">
              <a href="/status" class="link">Status</a>
            </li>
            <li class="link-list">
              <a href="/support" class="link">Support</a>
            </li>
          </ul>
        </nav>

        <!-- Dropdown Menu -->
        <div class="dropdown">
          <input
            type="checkbox"
            id="dropdown-checkbox"
            class="dropdown-checkbox"
          />
          <label for="dropdown-checkbox" class="dropdown-label">
            <img
              src="{% static 'images/colorful.png' %}"
              alt=""
              style="width: 60px; cursor: pointer"
            />
          </label>
          <div class="dropdown-content">
            <a href="{% url 'profile' %}">Profile</a>
            <a href="{% url 'log_out' %}">Log out</a>
          </div>
        </div>
      </header>

      <div class="main">
        <div class="nextpage">
          <a href="/search">Billboards</a>
          <a href="#">Billboard order</a>
        </div>
        <div class="top">
          <div class="billboard-image">
            <img src="{{ bill.image.url }}" alt="Billboard image" />
          </div>
          <div class="billboard-description">
            <div class="description">
              <ul>
                <li><strong>Address: </strong> {{bill.address}}</li>
                <li><strong>Category: </strong> {{bill.category}}</li>
                <li><strong>City: </strong> {{bill.city}}</li>
                <li><strong>District: </strong> {{bill.district}}</li>
                <li><strong>Size: </strong> {{bill.size}}</li>
                <li><strong>Billboard type: </strong> {{bill.type}}</li>
                <li><strong>Price </strong> {{bill.price}}</li>
              </ul>
            </div>
          </div>
        </div>
        <p>Select dates to order then pay â†“</p>

        <div class="utilities">
          <div class="calendar-container">
            <div id="calendar"></div>
          </div>
          <div class="booking content"></div>
        </div>
      </div>

      <div id="custom-alert" class="custom-alert">
        <span id="alert-message"></span>
        <button id="close-btn" class="close-btn">close;</button>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.10.2/fullcalendar.min.js"></script>
    <script>
      $(document).ready(function () {
        function showAlert(message) {
          var alertBox = document.getElementById("custom-alert");
          var alertMessage = document.getElementById("alert-message");
          alertMessage.textContent = message;
          alertBox.style.display = "block";
        }

        function hideAlert() {
          var alertBox = document.getElementById("custom-alert");
          alertBox.style.display = "none";
        }

        function closeAlert() {
          var alertBox = document.getElementById("custom-alert");
          alertBox.style.display = "none";
        }

        var calendar = $("#calendar").fullCalendar({
          header: {
            left: "prev,next today",
            center: "title",
            right: "bookButton",
          },
          defaultView: "month",
          editable: false,
          selectable: false, // Initially, selection is disabled
          selectHelper: true,
          eventLimit: true,
          select: function (start, end, allDay) {
            var confirmBooking = confirm(
              "Are you sure you want to continue with the selected dates?"
            );

            if (confirmBooking) {
              var start = $.fullCalendar.formatDate(start, "Y-MM-DD");
              var end = $.fullCalendar.formatDate(end, "Y-MM-DD");
              $.ajax({
                type: "GET",
                url: "/add_event",
                data: {
                  user_id: "{{user.id}}",
                  start: start,
                  end: end,
                  billboard_id: "{{bill.id}}",
                },
                dataType: "json",
                success: function (data) {
                  if (data.success) {
                    calendar.fullCalendar("refetchEvents");
                    showAlert(data.message);
                    calendar.fullCalendar("option", "selectable", false);
                    // Redirect to the payment page after successful booking
                    window.location.href =
                      "{% url 'payment' %}?address={{ bill.address }}";
                  } else {
                    showAlert(data.message); // Show the error message if there are overlapping bookings
                    calendar.fullCalendar("option", "selectable", false);
                  }
                },

                error: function (data) {
                  showAlert(data.message); // Show custom alert instead of browser alert
                  calendar.fullCalendar("option", "selectable", false);
                },
              });
            } else {
              calendar.fullCalendar("option", "selectable", false);
            }
          },
          eventSources: [
            {
              url: '{% url "bookings" pk=bill.id %}',
              type: "GET",
            },
          ],
          customButtons: {
            bookButton: {
              text: "Pick Dates",
              click: function () {
                // Enable selection
                calendar.fullCalendar("option", "selectable", true);
              },
            },
          },
        });

        // Attach click event listener to the close button
        document
          .getElementById("close-btn")
          .addEventListener("click", closeAlert);
      });
    </script>
  </body>
</html>
